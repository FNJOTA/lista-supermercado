<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lista de Supermercado Familiar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
            line-height: 1.4;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            line-height: 1.2;
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .main-content {
            padding: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .nav-buttons::-webkit-scrollbar {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
            min-width: fit-content;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.active {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn.shopping-mode {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .categories {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid;
        }

        .category.dairy { border-left-color: #ffd93d; }
        .category.meat { border-left-color: #ff6b6b; }
        .category.vegetables { border-left-color: #4ecdc4; }
        .category.fruits { border-left-color: #45b7d1; }
        .category.grains { border-left-color: #f9ca24; }
        .category.beverages { border-left-color: #6c5ce7; }
        .category.cleaning { border-left-color: #a29bfe; }
        .category.others { border-left-color: #fd79a8; }

        .category h3 {
            color: #333;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            touch-action: manipulation;
            min-height: 48px;
        }

        .item:active {
            transform: scale(0.98);
        }

        .item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .item.completed {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-color: #11998e;
            text-decoration: line-through;
            opacity: 0.8;
        }

        .item-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .item-name {
            flex-grow: 1;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .item-status {
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .add-custom-item {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .add-custom-item input {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .add-custom-item button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            min-width: 45px;
            touch-action: manipulation;
        }

        .add-custom-item button:active {
            transform: scale(0.95);
        }

        .saved-lists {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .saved-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease;
        }

        .saved-list:active {
            transform: scale(0.98);
        }

        .saved-list h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .saved-list-meta {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .saved-list-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .saved-item {
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .saved-item.completed {
            background: #d4edda;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .list-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .delete-list-btn, .shop-list-btn {
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            touch-action: manipulation;
            flex: 1;
            min-width: 100px;
        }

        .delete-list-btn {
            background: #dc3545;
            color: white;
        }

        .shop-list-btn {
            background: #ff9a56;
            color: white;
        }

        .delete-list-btn:active, .shop-list-btn:active {
            transform: scale(0.95);
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 6px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .shopping-header {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .shopping-header h2 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .shopping-progress {
            margin: 12px 0;
        }

        .shopping-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 12px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1rem;
        }

        .save-button-container {
            text-align: center;
            margin: 25px 0;
            padding: 0 10px;
        }

        .save-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 300px;
            touch-action: manipulation;
        }

        .save-button:active {
            transform: scale(0.95);
        }

        .save-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .finish-shopping-container {
            text-align: center;
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 10px;
        }

        .finish-shopping-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            touch-action: manipulation;
        }

        .exit-shopping-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            touch-action: manipulation;
        }

        .finish-shopping-btn:active, .exit-shopping-btn:active {
            transform: scale(0.95);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .pulse {
            width: 6px;
            height: 6px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 1; }
            70% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }

        /* Responsive */
        @media screen and (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 16px;
            }

            .container {
                border-radius: 10px;
                min-height: calc(100vh - 10px);
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .main-content {
                padding: 12px;
            }

            .categories {
                gap: 15px;
            }

            .category {
                padding: 12px;
            }

            .item {
                padding: 10px;
                min-height: 44px;
            }

            .item-name {
                font-size: 0.9rem;
            }

            .shopping-stats {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: left;
            }

            .stat {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgba(255,255,255,0.2);
                padding: 8px 12px;
                border-radius: 8px;
            }

            .stat-number {
                font-size: 1.3rem;
            }

            .saved-list-items {
                grid-template-columns: 1fr;
            }

            .list-actions {
                flex-direction: column;
            }

            .delete-list-btn, .shop-list-btn {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Lista de Supermercado Familiar</h1>
            <p>Organizar compras de supermercado para no olvidarse de NADA!</p>
            <div class="connection-status">
                <div class="status-indicator" id="connection-status"></div>
                <span id="connection-text">Conectando...</span>
                <div class="realtime-indicator">
                    <div class="pulse"></div>
                    <span>En tiempo real</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="nav-buttons">
                <button class="btn active touchable" onclick="showSection('new-list')">üìù Nueva Lista</button>
                <button class="btn touchable" onclick="showSection('saved-lists')">üìã Listas Guardadas</button>
            </div>

            <!-- Nueva Lista -->
            <div id="new-list" class="section active">
                <div class="form-group">
                    <label for="list-name">Nombre de la lista:</label>
                    <input type="text" id="list-name" placeholder="Ej: Lista quincenal, Compra para el asado...">
                </div>

                <div class="form-group">
                    <label for="family-member">Creada por:</label>
                    <select id="family-member">
                        <option value="Pap√°">üë® Pap√°</option>
                        <option value="Mam√°">üë© Mam√°</option>
                        <option value="Hijo/a 1">üë¶ Hijo/a 1</option>
                        <option value="Hijo/a 2">üëß Hijo/a 2</option>
                        <option value="Otro">üë§ Otro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="list-date">Fecha:</label>
                    <input type="date" id="list-date">
                </div>

                <div class="categories" id="categories-container">
                    <!-- Las categor√≠as se generar√°n din√°micamente -->
                </div>

                <div class="save-button-container">
                    <button class="save-button touchable" onclick="saveList()" id="save-btn">
                        üíæ Guardar Lista
                    </button>
                </div>
            </div>

            <!-- Listas Guardadas -->
            <div id="saved-lists" class="section">
                <div id="saved-lists-container">
                    <!-- Las listas guardadas se mostrar√°n aqu√≠ -->
                </div>
            </div>

            <!-- Modo Compra -->
            <div id="shopping-mode" class="section">
                <div class="shopping-header">
                    <h2 id="shopping-list-name">üõí Modo Compra</h2>
                    <div class="shopping-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="shopping-progress"></div>
                        </div>
                    </div>
                    <div class="shopping-stats">
                        <div class="stat">
                            <span class="stat-label">Completados</span>
                            <span class="stat-number" id="completed-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Pendientes</span>
                            <span class="stat-number" id="remaining-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Progreso</span>
                            <span class="stat-number" id="progress-percent">0%</span>
                        </div>
                    </div>
                </div>

                <div class="categories" id="shopping-categories-container">
                    <!-- Las categor√≠as para modo compra se generar√°n aqu√≠ -->
                </div>

                <div class="finish-shopping-container">
                    <button class="finish-shopping-btn touchable" onclick="finishShopping()">
                        ‚úÖ Finalizar Compra
                    </button>
                    <button class="exit-shopping-btn touchable" onclick="exitShoppingMode()">
                        ‚Üê Volver a Listas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.39.0/umd/index.min.js"></script>
    
    <script>
        // CONFIGURACI√ìN DE SUPABASE
        // ‚ö†Ô∏è IMPORTANTE: Reemplaza estos valores con tu configuraci√≥n real de Supabase
        const SUPABASE_URL = 'https://fkbibznxasdkzrrqecul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrYmliem54YXNka3pycnFlY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MTUxNDcsImV4cCI6MjA2Njk5MTE0N30.usnm1yQ3dWdjvUHPW3YZmL3WQQJyp6lD3ot8IqmpSwA';
        
        // Inicializar Supabase
        let supabase = null;
        let isConnected = false;
        let realTimeSubscription = null;

        // Variables globales
        let currentListData = {};
        let customItems = {};
        let currentShoppingList = null;
        let shoppingMode = false;
        let savedLists = [];

        // Productos base organizados por categor√≠as
        const baseProducts = {
            dairy: {
                name: "ü•õ L√°cteos",
                items: ["Leche", "Queso", "Yogur", "Mantequilla", "Crema", "Queso crema"]
            },
            meat: {
                name: "ü•© Carnes y Pescados",
                items: ["Pollo", "Carne de res", "Cerdo", "Pescado", "Embutidos", "Huevos"]
            },
            vegetables: {
                name: "ü•¨ Verduras",
                items: ["Lechuga", "Tomates", "Cebollas", "Papas", "Zanahorias", "Apio", "Pimientos"]
            },
            fruits: {
                name: "üçé Frutas",
                items: ["Manzanas", "Pl√°tanos", "Naranjas", "Limones", "Fresas", "Uvas"]
            },
            grains: {
                name: "üåæ Cereales y Granos",
                items: ["Arroz", "Pan", "Pasta", "Avena", "Quinoa", "Harina"]
            },
            beverages: {
                name: "ü•§ Bebidas",
                items: ["Agua", "Jugos", "Refrescos", "Caf√©", "T√©", "Cerveza"]
            },
            cleaning: {
                name: "üßΩ Limpieza",
                items: ["Detergente", "Jab√≥n", "Papel higi√©nico", "Toallas de papel", "Desinfectante"]
            },
            others: {
                name: "üè™ Otros",
                items: ["Aceite", "Sal", "Az√∫car", "Especias", "Snacks", "Medicinas"]
            }
        };

        // Funciones de Supabase
        async function initSupabase() {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY || 
                SUPABASE_URL === 'TU_SUPABASE_URL_AQUI' || 
                SUPABASE_ANON_KEY === 'TU_SUPABASE_ANON_KEY_AQUI') {
                updateConnectionStatus(false, 'Configurar Supabase');
                console.error('Por favor, configura tu URL y clave de Supabase');
                return;
            }

            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Verificar conexi√≥n
                const { data, error } = await supabase.from('shopping_lists').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                isConnected = true;
                updateConnectionStatus(true, 'Conectado');
                setupRealTimeSubscription();
                
            } catch (error) {
                console.error('Error conectando con Supabase:', error);
                updateConnectionStatus(false, 'Error de conexi√≥n');
                isConnected = false;
            }
        }

        function updateConnectionStatus(connected, message) {
            const indicator = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            
            if (connected) {
                indicator.classList.remove('disconnected');
                text.textContent = message;
            } else {
                indicator.classList.add('disconnected');
                text.textContent = message;
            }
        }

        function setupRealTimeSubscription() {
            if (!supabase || !isConnected) return;

            realTimeSubscription = supabase
                .channel('shopping_lists_changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'shopping_lists' },
                    (payload) => {
                        console.log('Cambio detectado:', payload);
                        loadSavedLists(); // Recargar listas cuando hay cambios
                        
                        // Si estamos en modo compra y la lista actual cambi√≥
                        if (shoppingMode && currentShoppingList && 
                            payload.new && payload.new.id === currentShoppingList.id) {
                            currentShoppingList = payload.new;
                            generateShoppingCategories();
                            updateShoppingProgress();
                        }
                    }
                )
                .subscribe();
        }

        // Funciones CRUD para Supabase
        async function saveListToSupabase(listData) {
            if (!supabase || !isConnected) {
                throw new Error('No hay conexi√≥n con Supabase');
            }

            const { data, error } = await supabase
                .from('shopping_lists')
                .insert([listData])
                .select();

            if (error) {
                throw error;
            }

            return data[0];
        }

        async function loadListsFromSupabase() {
            if (!supabase || !isConnected) {
                return [];
            }

            const { data, error } = await supabase
                .from('shopping_lists')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error cargando listas:', error);
                return [];
            }

            return data || [];
        }

        async function updateListInSupabase(listId, updates) {
            if (!supabase || !isConnected) {
                throw new Error('No hay conexi√≥n con Supabase');
            }

            const { data, error } = await supabase
                .from('shopping_lists')
                .update(updates)
                .eq('id', listId)
                .select();

            if (error) {
                throw error;
            }

            return data[0];
        }

        async function deleteListFromSupabase(listId) {
            if (!supabase || !isConnected) {
                throw new Error('No hay conexi√≥n con Supabase');
            }

            const { error } = await supabase
                .from('shopping_lists')
                .delete()
                .eq('id', listId);

            if (error) {
                throw error;
            }
        }

        // Funciones principales
        async function init() {
            setTodayDate();
            generateCategories();
            await initSupabase();
            await loadSavedLists();
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('list-date').value = today;
        }

        function generateCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            
            Object.keys(baseProducts).forEach(categoryKey => {
                const category = baseProducts[categoryKey];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category ${categoryKey}`;
                
                let itemsHTML = '';
                category.items.forEach(item => {
                    const itemId = `${categoryKey}-${item.replace(/\s+/g, '-')}`;
                    itemsHTML += `
                        <div class="item touchable" onclick="toggleItem('${categoryKey}', '${item}')">
                            <input type="checkbox" class="item-checkbox" id="${itemId}">
                            <span class="item-name">${item}</span>
                            <span class="item-status">üì¶</span>
                        </div>
                    `;
                });
                
                categoryDiv.innerHTML = `
                    <h3>${category.name}</h3>
                    ${itemsHTML}
                    <div class="add-custom-item">
                        <input type="text" placeholder="Agregar art√≠culo personalizado..." id="custom-${categoryKey}">
                        <button class="touchable" onclick="addCustomItem('${categoryKey}')">‚ûï</button>
                    </div>
                `;
                
                container.appendChild(categoryDiv);
            });
        }

        function toggleItem(category, item) {
            if (!currentListData[category]) {
                currentListData[category] = {};
            }
            
            currentListData[category][item] = !currentListData[category][item];
            updateItemVisual(category, item);
        }

        function updateItemVisual(category, item) {
            const itemId = `${category}-${item.replace(/\s+/g, '-')}`;
            const checkbox = document.getElementById(itemId);
            if (!checkbox) return;
            
            const itemDiv = checkbox.parentElement;
            
            if (currentListData[category] && currentListData[category][item]) {
                itemDiv.classList.add('selected');
                checkbox.checked = true;
            } else {
                itemDiv.classList.remove('selected');
                checkbox.checked = false;
            }
        }

        function addCustomItem(category) {
            const input = document.getElementById(`custom-${category}`);
            const itemName = input.value.trim();
            
            if (itemName) {
                if (!customItems[category]) {
                    customItems[category] = [];
                }
                
                if (!customItems[category].includes(itemName)) {
                    customItems[category].push(itemName);
                    addCustomItemToCategory(category, itemName);
                    input.value = '';
                }
            }
        }

        function addCustomItemToCategory(category, itemName) {
            const categoryDiv = document.querySelector(`.category.${category}`);
            const addCustomDiv = categoryDiv.querySelector('.add-custom-item');
            
            const itemId = `${category}-${itemName.replace(/\s+/g, '-')}`;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item touchable';
            itemDiv.onclick = () => toggleItem(category, itemName);
            
            itemDiv.innerHTML = `
                <input type="checkbox" class="item-checkbox" id="${itemId}">
                <span class="item-name">${itemName}</span>
                <span class="item-status">üì¶</span>
            `;
            
            categoryDiv.insertBefore(itemDiv, addCustomDiv);
        }

        async function saveList() {
            const listName = document.getElementById('list-name').value.trim();
            const familyMember = document.getElementById('family-member').value;
            const listDate = document.getElementById('list-date').value;
            
            if (!listName) {
                alert('Por favor, ingresa un nombre para la lista');
                return;
            }
            
            // Recopilar todos los items seleccionados
            const selectedItems = {};
            let totalItems = 0;
            
            Object.keys(currentListData).forEach(category => {
                Object.keys(currentListData[category]).forEach(item => {
                    if (currentListData[category][item]) {
                        if (!selectedItems[category]) {
                            selectedItems[category] = {};
                        }
                        selectedItems[category][item] = {
                            selected: true,
                            completed: false
                        };
                        totalItems++;
                    }
                });
            });
            
            if (totalItems === 0) {
                alert('Por favor, selecciona al menos un art√≠culo');
                return;
            }
            
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<div class="loading"></div> Guardando...';
            saveBtn.disabled = true;
            
            try {
                const listData = {
                    name: listName,
                    created_by: familyMember,
                    date: listDate,
                    items: selectedItems,
                    custom_items: customItems,
                    total_items: totalItems,
                    completed_items: 0,
                    is_completed: false,
                    created_at: new Date().toISOString()
                };
                
                if (isConnected) {
                    await saveListToSupabase(listData);
                } else {
                    // Guardar localmente si no hay conexi√≥n
                    const localLists = JSON.parse(localStorage.getItem('shopping_lists') || '[]');
                    listData.id = Date.now(); // ID temporal
                    localLists.unshift(listData);
                    localStorage.setItem('shopping_lists', JSON.stringify(localLists));
                }
                
                // Limpiar formulario
                document.getElementById('list-name').value = '';
                currentListData = {};
                customItems = {};
                generateCategories();
                
                // Recargar listas guardadas
                await loadSavedLists();
                
                // Cambiar a la vista de listas guardadas
                showSection('saved-lists');
                
                alert('¬°Lista guardada exitosamente!');
                
            } catch (error) {
                console.error('Error guardando lista:', error);
                alert('Error al guardar la lista. Int√©ntalo de nuevo.');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        async function loadSavedLists() {
            const container = document.getElementById('saved-lists-container');
            
            try {
                let lists = [];
                
                if (isConnected) {
                    lists = await loadListsFromSupabase();
                } else {
                    // Cargar desde localStorage
                    lists = JSON.parse(localStorage.getItem('shopping_lists') || '[]');
                }
                
                savedLists = lists;
                
                if (lists.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>üìù No hay listas guardadas</h3>
                            <p>Crea tu primera lista de supermercado</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                lists.forEach(list => {
                    const listDiv = document.createElement('div');
                    listDiv.className = 'saved-list';
                    
                    const progress = list.total_items > 0 ? 
                        Math.round((list.completed_items / list.total_items) * 100) : 0;
                    
                    const formattedDate = new Date(list.date).toLocaleDateString('es-ES');
                    
                    let itemsHTML = '';
                    Object.keys(list.items || {}).forEach(category => {
                        Object.keys(list.items[category] || {}).forEach(item => {
                            const itemData = list.items[category][item];
                            const completedClass = itemData.completed ? 'completed' : '';
                            itemsHTML += `
                                <div class="saved-item ${completedClass}">
                                    ${itemData.completed ? '‚úÖ' : 'üì¶'} ${item}
                                </div>
                            `;
                        });
                    });
                    
                    listDiv.innerHTML = `
                        <h3>${list.name}</h3>
                        <div class="saved-list-meta">
                            üë§ ${list.created_by} ‚Ä¢ üìÖ ${formattedDate} ‚Ä¢ 
                            ${list.completed_items}/${list.total_items} completados (${progress}%)
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="saved-list-items">
                            ${itemsHTML}
                        </div>
                        <div class="list-actions">
                            <button class="shop-list-btn touchable" onclick="startShopping(${list.id || lists.indexOf(list)})">
                                üõí Ir de Compras
                            </button>
                            <button class="delete-list-btn touchable" onclick="deleteList(${list.id || lists.indexOf(list)})">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(listDiv);
                });
                
            } catch (error) {
                console.error('Error cargando listas:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Error cargando listas</h3>
                        <p>No se pudieron cargar las listas guardadas</p>
                    </div>
                `;
            }
        }

        async function deleteList(listId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta lista?')) {
                return;
            }
            
            try {
                if (isConnected) {
                    await deleteListFromSupabase(listId);
                } else {
                    // Eliminar de localStorage
                    const localLists = JSON.parse(localStorage.getItem('shopping_lists') || '[]');
                    localLists.splice(listId, 1);
                    localStorage.setItem('shopping_lists', JSON.stringify(localLists));
                }
                
                await loadSavedLists();
                
            } catch (error) {
                console.error('Error eliminando lista:', error);
                alert('Error al eliminar la lista');
            }
        }

        function startShopping(listId) {
            const list = isConnected ? 
                savedLists.find(l => l.id === listId) : 
                savedLists[listId];
            
            if (!list) {
                alert('Lista no encontrada');
                return;
            }
            
            currentShoppingList = list;
            shoppingMode = true;
            
            // Actualizar navegaci√≥n
            const navButtons = document.querySelector('.nav-buttons');
            navButtons.innerHTML = `
                <button class="btn shopping-mode active touchable">üõí Modo Compra</button>
            `;
            
            showSection('shopping-mode');
            generateShoppingCategories();
            updateShoppingProgress();
        }

        function generateShoppingCategories() {
            if (!currentShoppingList) return;
            
            const container = document.getElementById('shopping-categories-container');
            const listNameElement = document.getElementById('shopping-list-name');
            
            listNameElement.textContent = `üõí ${currentShoppingList.name}`;
            container.innerHTML = '';
            
            Object.keys(currentShoppingList.items || {}).forEach(categoryKey => {
                const category = baseProducts[categoryKey];
                if (!category) return;
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category ${categoryKey}`;
                
                let itemsHTML = '';
                Object.keys(currentShoppingList.items[categoryKey] || {}).forEach(item => {
                    const itemData = currentShoppingList.items[categoryKey][item];
                    const itemId = `shopping-${categoryKey}-${item.replace(/\s+/g, '-')}`;
                    const completedClass = itemData.completed ? 'completed' : '';
                    
                    itemsHTML += `
                        <div class="item touchable ${completedClass}" onclick="toggleShoppingItem('${categoryKey}', '${item}')">
                            <input type="checkbox" class="item-checkbox" id="${itemId}" ${itemData.completed ? 'checked' : ''}>
                            <span class="item-name">${item}</span>
                            <span class="item-status">${itemData.completed ? '‚úÖ' : 'üì¶'}</span>
                        </div>
                    `;
                });
                
                if (itemsHTML) {
                    categoryDiv.innerHTML = `
                        <h3>${category.name}</h3>
                        ${itemsHTML}
                    `;
                    container.appendChild(categoryDiv);
                }
            });
        }

        async function toggleShoppingItem(category, item) {
            if (!currentShoppingList || !currentShoppingList.items[category] || !currentShoppingList.items[category][item]) {
                return;
            }
            
            // Toggle estado
            currentShoppingList.items[category][item].completed = !currentShoppingList.items[category][item].completed;
            
            // Actualizar contadores
            let completedItems = 0;
            Object.keys(currentShoppingList.items).forEach(cat => {
                Object.keys(currentShoppingList.items[cat]).forEach(itm => {
                    if (currentShoppingList.items[cat][itm].completed) {
                        completedItems++;
                    }
                });
            });
            
            currentShoppingList.completed_items = completedItems;
            
            // Actualizar visual
            updateShoppingItemVisual(category, item);
            updateShoppingProgress();
            
            // Guardar cambios
            try {
                if (isConnected) {
                    await updateListInSupabase(currentShoppingList.id, {
                        items: currentShoppingList.items,
                        completed_items: currentShoppingList.completed_items
                    });
                } else {
                    // Actualizar localStorage
                    const localLists = JSON.parse(localStorage.getItem('shopping_lists') || '[]');
                    const listIndex = localLists.findIndex(l => l.id === currentShoppingList.id);
                    if (listIndex !== -1) {
                        localLists[listIndex] = currentShoppingList;
                        localStorage.setItem('shopping_lists', JSON.stringify(localLists));
                    }
                }
            } catch (error) {
                console.error('Error actualizando item:', error);
            }
        }

        function updateShoppingItemVisual(category, item) {
            const itemId = `shopping-${category}-${item.replace(/\s+/g, '-')}`;
            const checkbox = document.getElementById(itemId);
            if (!checkbox) return;
            
            const itemDiv = checkbox.parentElement;
            const statusSpan = itemDiv.querySelector('.item-status');
            
            if (currentShoppingList.items[category][item].completed) {
                itemDiv.classList.add('completed');
                checkbox.checked = true;
                statusSpan.textContent = '‚úÖ';
            } else {
                itemDiv.classList.remove('completed');
                checkbox.checked = false;
                statusSpan.textContent = 'üì¶';
            }
        }

        function updateShoppingProgress() {
            if (!currentShoppingList) return;
            
            const completedCount = currentShoppingList.completed_items || 0;
            const totalCount = currentShoppingList.total_items || 0;
            const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            document.getElementById('completed-count').textContent = completedCount;
            document.getElementById('remaining-count').textContent = totalCount - completedCount;
            document.getElementById('progress-percent').textContent = `${progress}%`;
            document.getElementById('shopping-progress').style.width = `${progress}%`;
        }

        async function finishShopping() {
            if (!currentShoppingList) return;
            
            const completedItems = currentShoppingList.completed_items || 0;
            const totalItems = currentShoppingList.total_items || 0;
            
            if (completedItems < totalItems) {
                const remainingItems = totalItems - completedItems;
                if (!confirm(`A√∫n tienes ${remainingItems} art√≠culos pendientes. ¬øQuieres finalizar la compra de todas formas?`)) {
                    return;
                }
            }
            
            try {
                currentShoppingList.is_completed = true;
                currentShoppingList.completed_at = new Date().toISOString();
                
                if (isConnected) {
                    await updateListInSupabase(currentShoppingList.id, {
                        is_completed: true,
                        completed_at: currentShoppingList.completed_at
                    });
                } else {
                    // Actualizar localStorage
                    const localLists = JSON.parse(localStorage.getItem('shopping_lists') || '[]');
                    const listIndex = localLists.findIndex(l => l.id === currentShoppingList.id);
                    if (listIndex !== -1) {
                        localLists[listIndex] = currentShoppingList;
                        localStorage.setItem('shopping_lists', JSON.stringify(localLists));
                    }
                }
                
                alert('¬°Compra finalizada exitosamente! üéâ');
                exitShoppingMode();
                
            } catch (error) {
                console.error('Error finalizando compra:', error);
                alert('Error al finalizar la compra');
            }
        }

        function exitShoppingMode() {
            shoppingMode = false;
            currentShoppingList = null;
            
            // Restaurar navegaci√≥n
            const navButtons = document.querySelector('.nav-buttons');
            navButtons.innerHTML = `
                <button class="btn touchable" onclick="showSection('new-list')">üìù Nueva Lista</button>
                <button class="btn active touchable" onclick="showSection('saved-lists')">üìã Listas Guardadas</button>
            `;
            
            showSection('saved-lists');
            loadSavedLists();
        }

        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(sectionName).classList.add('active');
            
            // Actualizar botones de navegaci√≥n (solo si no estamos en modo compra)
            if (!shoppingMode) {
                document.querySelectorAll('.nav-buttons .btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const activeBtn = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            }
        }

        // Event listeners para inputs personalizados
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Agregar event listeners para Enter en campos de texto personalizados
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.target.id && e.target.id.startsWith('custom-')) {
                    const category = e.target.id.replace('custom-', '');
                    addCustomItem(category);
                }
            });
        });

        // Manejo de eventos t√°ctiles mejorado
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('touchable')) {
                e.target.style.opacity = '0.7';
            }
        });

        document.addEventListener('touchend', function(e) {
            if (e.target.classList.contains('touchable')) {
                e.target.style.opacity = '1';
            }
        });

        // Prevenir zoom en double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
