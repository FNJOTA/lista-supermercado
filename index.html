<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lista de Supermercado Familiar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
            line-height: 1.4;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            line-height: 1.2;
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .main-content {
            padding: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .nav-buttons::-webkit-scrollbar {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
            min-width: fit-content;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.active {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn.shopping-mode {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
        }

        .btn.edit-mode {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .categories {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid;
        }

        .category.dairy { border-left-color: #ffd93d; }
        .category.meat { border-left-color: #ff6b6b; }
        .category.vegetables { border-left-color: #4ecdc4; }
        .category.fruits { border-left-color: #45b7d1; }
        .category.grains { border-left-color: #f9ca24; }
        .category.beverages { border-left-color: #6c5ce7; }
        .category.cleaning { border-left-color: #a29bfe; }
        .category.others { border-left-color: #fd79a8; }

        .category h3 {
            color: #333;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            touch-action: manipulation;
            min-height: 48px;
            position: relative;
        }

        .item:active {
            transform: scale(0.98);
        }

        .item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .item.completed {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-color: #11998e;
            text-decoration: line-through;
            opacity: 0.8;
        }

        .item-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .item-name {
            flex-grow: 1;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .item-status {
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .item-remove {
            background: #dc3545;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .edit-mode .item-remove {
            display: flex;
        }

        .item-remove:active {
            transform: scale(0.9);
        }

        .add-custom-item {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .add-custom-item input {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .add-custom-item button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            min-width: 45px;
            touch-action: manipulation;
        }

        .add-custom-item button:active {
            transform: scale(0.95);
        }

        .saved-lists {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .saved-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease;
        }

        .saved-list:active {
            transform: scale(0.98);
        }

        .saved-list h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .saved-list-meta {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .saved-list-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .saved-item {
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .saved-item.completed {
            background: #d4edda;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .list-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .delete-list-btn, .shop-list-btn, .edit-list-btn {
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            touch-action: manipulation;
            flex: 1;
            min-width: 100px;
        }

        .delete-list-btn {
            background: #dc3545;
            color: white;
        }

        .shop-list-btn {
            background: #ff9a56;
            color: white;
        }

        .edit-list-btn {
            background: #f39c12;
            color: white;
        }

        .delete-list-btn:active, .shop-list-btn:active, .edit-list-btn:active {
            transform: scale(0.95);
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 6px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .shopping-header, .edit-header {
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .shopping-header {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
        }

        .edit-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .shopping-header h2, .edit-header h2 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .shopping-progress {
            margin: 12px 0;
        }

        .shopping-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 12px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1rem;
        }

        .save-button-container {
            text-align: center;
            margin: 25px 0;
            padding: 0 10px;
        }

        .save-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 300px;
            touch-action: manipulation;
        }

        .save-button:active {
            transform: scale(0.95);
        }

        .save-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .finish-shopping-container, .finish-editing-container {
            text-align: center;
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 10px;
        }

        .finish-shopping-btn, .finish-editing-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            touch-action: manipulation;
        }

        .exit-shopping-btn, .exit-editing-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            touch-action: manipulation;
        }

        .finish-shopping-btn:active, .exit-shopping-btn:active,
        .finish-editing-btn:active, .exit-editing-btn:active {
            transform: scale(0.95);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .pulse {
            width: 6px;
            height: 6px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 1; }
            70% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }

        /* Edit mode styles */
        .edit-mode-controls {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .edit-mode-controls h4 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .edit-mode-controls p {
            color: #856404;
            font-size: 0.85rem;
            margin: 0;
        }

        /* Responsive */
        @media screen and (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 16px;
            }

            .container {
                border-radius: 10px;
                min-height: calc(100vh - 10px);
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .main-content {
                padding: 12px;
            }

            .categories {
                gap: 15px;
            }

            .category {
                padding: 12px;
            }

            .item {
                padding: 10px;
                min-height: 44px;
            }

            .item-name {
                font-size: 0.9rem;
            }

            .shopping-stats {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: left;
            }

            .stat {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgba(255,255,255,0.2);
                padding: 8px 12px;
                border-radius: 8px;
            }

            .stat-number {
                font-size: 1.3rem;
            }

            .saved-list-items {
                grid-template-columns: 1fr;
            }

            .list-actions {
                flex-direction: column;
            }

            .delete-list-btn, .shop-list-btn, .edit-list-btn {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Lista de Supermercado Familiar</h1>
            <p>Organizar compras de supermercado para no olvidarse de NADA!</p>
            <div class="connection-status">
                <div class="status-indicator" id="connection-status"></div>
                <span id="connection-text">Conectando...</span>
                <div class="realtime-indicator">
                    <div class="pulse"></div>
                    <span>En tiempo real</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="nav-buttons">
                <button class="btn active touchable" onclick="showSection('new-list')">üìù Nueva Lista</button>
                <button class="btn touchable" onclick="showSection('saved-lists')">üìã Listas Guardadas</button>
            </div>

            <!-- Nueva Lista -->
            <div id="new-list" class="section active">
                <div class="form-group">
                    <label for="list-name">Nombre de la lista:</label>
                    <input type="text" id="list-name" placeholder="Ej: Lista quincenal, Compra para el asado...">
                </div>

                <div class="form-group">
                    <label for="family-member">Creada por:</label>
                    <select id="family-member">
                        <option value="Pap√°">üë® Pap√°</option>
                        <option value="Mam√°">üë© Mam√°</option>
                        <option value="Hijo/a 1">üë¶ Hijo</option>
                        <option value="Hijo/a 2">üëß Hija </option>
                        <option value="Otro">üë§ Otro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="list-date">Fecha:</label>
                    <input type="date" id="list-date">
                </div>

                <div class="categories" id="categories-container">
                    <!-- Las categor√≠as se generar√°n din√°micamente -->
                </div>

                <div class="save-button-container">
                    <button class="save-button touchable" onclick="saveList()" id="save-btn">
                        üíæ Guardar Lista
                    </button>
                </div>
            </div>

            <!-- Listas Guardadas -->
            <div id="saved-lists" class="section">
                <div id="saved-lists-container">
                    <!-- Las listas guardadas se mostrar√°n aqu√≠ -->
                </div>
            </div>

            <!-- Modo Compra -->
            <div id="shopping-mode" class="section">
                <div class="shopping-header">
                    <h2 id="shopping-list-name">üõí Modo Compra</h2>
                    <div class="shopping-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="shopping-progress"></div>
                        </div>
                    </div>
                    <div class="shopping-stats">
                        <div class="stat">
                            <span class="stat-label">Completados</span>
                            <span class="stat-number" id="completed-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Pendientes</span>
                            <span class="stat-number" id="remaining-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Progreso</span>
                            <span class="stat-number" id="progress-percent">0%</span>
                        </div>
                    </div>
                </div>

                <div class="categories" id="shopping-categories-container">
                    <!-- Las categor√≠as para modo compra se generar√°n aqu√≠ -->
                </div>

                <div class="finish-shopping-container">
                    <button class="finish-shopping-btn touchable" onclick="finishShopping()">
                        ‚úÖ Finalizar Compra
                    </button>
                    <button class="exit-shopping-btn touchable" onclick="exitShoppingMode()">
                        ‚Üê Volver a Listas
                    </button>
                </div>
            </div>

            <!-- Modo Edici√≥n -->
            <div id="edit-mode" class="section">
                <div class="edit-header">
                    <h2 id="edit-list-name">‚úèÔ∏è Editar Lista</h2>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="edit-list-name-input" style="color: white;">Nombre de la lista:</label>
                        <input type="text" id="edit-list-name-input" style="margin-top: 8px;">
                    </div>
                    <div class="form-group">
                        <label for="edit-family-member" style="color: white;">Editada por:</label>
                        <select id="edit-family-member" style="margin-top: 8px;">
                            <option value="Pap√°">üë® Pap√°</option>
                            <option value="Mam√°">üë© Mam√°</option>
                            <option value="Hijo/a 1">üë¶ Hijo/a 1</option>
                            <option value="Hijo/a 2">üëß Hijo/a 2</option>
                            <option value="Otro">üë§ Otro</option>
                        </select>
                    </div>
                </div>

                <div class="edit-mode-controls">
                    <h4>üéØ Modo Edici√≥n Activado</h4>
                    <p>Puedes agregar nuevos elementos, eliminar existentes con el bot√≥n ‚ùå, y modificar el nombre de la lista</p>
                </div>

                <div class="categories edit-mode" id="edit-categories-container">
                    <!-- Las categor√≠as para modo edici√≥n se generar√°n aqu√≠ -->
                </div>

                <div class="finish-editing-container">
                    <button class="finish-editing-btn touchable" onclick="saveEditedList()">
                        üíæ Guardar Cambios
                    </button>
                    <button class="exit-editing-btn touchable" onclick="exitEditMode()">
                        ‚Üê Cancelar Edici√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.39.0/umd/index.min.js"></script>
    
    <script>
        // CONFIGURACI√ìN DE SUPABASE
        // ‚ö†Ô∏è IMPORTANTE: Reemplaza estos valores con tu configuraci√≥n real de Supabase
        const SUPABASE_URL = 'https://fkbibznxasdkzrrqecul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrYmliem54YXNka3pycnFlY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MTUxNDcsImV4cCI6MjA2Njk5MTE0N30.usnm1yQ3dWdjvUHPW3YZmL3WQQJyp6lD3ot8IqmpSwA';
        
        // Inicializar Supabase
        let supabase = null;
        let isConnected = false;
        let realTimeSubscription = null;

        // Variables globales
        let currentListData = {};
        let customItems = {};
        let currentShoppingList = null;
        let currentEditingList = null;
        let shoppingMode = false;
        let editMode = false;
        let savedLists = [];

        // Productos base organizados por categor√≠as
        const baseProducts = {
            dairy: {
                name: "ü•õ L√°cteos",
                items: ["Leche", "Queso", "Yogur", "Mantequilla", "Crema", "Queso crema"]
            },
            meat: {
                name: "ü•© Carnes y Pescados",
                items: ["Pollo", "Carne de res", "Cerdo", "Pescado", "Embutidos", "Huevos"]
            },
            vegetables: {
                name: "ü•¨ Verduras",
                items: ["Lechuga", "Tomates", "Cebollas", "Papas", "Zanahorias", "Apio", "Pimientos"]
            },
            fruits: {
                name: "üçé Frutas",
                items: ["Manzanas", "Pl√°tanos", "Naranjas", "Limones", "Fresas", "Uvas"]
            },
            grains: {
                name: "üåæ Cereales y Granos",
                items: ["Arroz", "Pan", "Pasta", "Avena", "Quinoa", "Harina"]
            },
            beverages: {
                name: "ü•§ Bebidas",
                items: ["Agua", "Jugos", "Refrescos", "Caf√©", "T√©", "Cerveza"]
            },
            cleaning: {
                name: "üßΩ Limpieza",
                items: ["Detergente", "Jab√≥n", "Papel higi√©nico", "Toallas de papel", "Desinfectante"]
            },
            others: {
                name: "üè™ Otros",
                items: ["Aceite", "Sal", "Az√∫car", "Especias", "Snacks", "Medicinas"]
            }
        };

        // Funciones de Supabase
        async function initSupabase() {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY || 
                SUPABASE_URL === 'TU_SUPABASE_URL_AQUI' || 
                SUPABASE_ANON_KEY === 'TU_SUPABASE_ANON_KEY_AQUI') {
                updateConnectionStatus(false, 'Configurar Supabase');
                console.error('Por favor, configura tu URL y clave de Supabase');
                return;
            }

            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Verificar conexi√≥n
                const { data, error } = await supabase.from('shopping_lists').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                isConnected = true;
                updateConnectionStatus(true, 'Conectado');
                setupRealTimeSubscription();
                
            } catch (error) {
                console.error('Error conectando con Supabase:', error);
                updateConnectionStatus(false, 'Error de conexi√≥n');
                isConnected = false;
            }
        }

        function updateConnectionStatus(connected, message) {
            const indicator = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            
            if (connected) {
                indicator.classList.remove('disconnected');
                text.textContent = message;
            } else {
                indicator.classList.add('disconnected');
                text.textContent = message;
            }
        }

        function setupRealTimeSubscription() {
            if (!supabase) return;
            
            realTimeSubscription = supabase
                .channel('shopping_lists_changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'shopping_lists' },
                    (payload) => {
                        console.log('Cambio en tiempo real:', payload);
                        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE' || payload.eventType === 'DELETE') {
                            loadSavedLists();
                        }
                    }
                )
                .subscribe();
        }

        // Funci√≥n para guardar lista en Supabase
        async function saveToSupabase(listData) {
            if (!isConnected) {
                alert('No hay conexi√≥n a la base de datos. La lista se guardar√° localmente.');
                return false;
            }

            try {
                const { data, error } = await supabase
                    .from('shopping_lists')
                    .insert([listData]);

                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error guardando en Supabase:', error);
                return false;
            }
        }

        // Funci√≥n para cargar listas de Supabase
        async function loadFromSupabase() {
            if (!isConnected) return [];

            try {
                const { data, error } = await supabase
                    .from('shopping_lists')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error cargando de Supabase:', error);
                return [];
            }
        }

        // Funci√≥n para actualizar lista en Supabase
        async function updateInSupabase(id, listData) {
            if (!isConnected) return false;

            try {
                const { data, error } = await supabase
                    .from('shopping_lists')
                    .update(listData)
                    .eq('id', id);

                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error actualizando en Supabase:', error);
                return false;
            }
        }

        // Funci√≥n para eliminar lista de Supabase
        async function deleteFromSupabase(id) {
            if (!isConnected) return false;

            try {
                const { data, error } = await supabase
                    .from('shopping_lists')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error eliminando de Supabase:', error);
                return false;
            }
        }

        // Funciones principales
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(sectionId).classList.add('active');
            
            // Actualizar botones de navegaci√≥n
            document.querySelectorAll('.nav-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activar el bot√≥n correspondiente
            if (sectionId === 'new-list') {
                document.querySelector('.nav-buttons .btn:first-child').classList.add('active');
            } else if (sectionId === 'saved-lists') {
                document.querySelector('.nav-buttons .btn:last-child').classList.add('active');
                loadSavedLists();
            }
        }

        function generateCategories(containerId, forShopping = false, forEditing = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            Object.keys(baseProducts).forEach(categoryKey => {
                const category = baseProducts[categoryKey];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category ${categoryKey}`;
                
                let categoryHTML = `<h3>${category.name}</h3>`;
                
                // Generar items de la categor√≠a
                category.items.forEach(item => {
                    const itemId = `${categoryKey}-${item.replace(/\s+/g, '-').toLowerCase()}`;
                    const isSelected = currentListData[itemId] || false;
                    const isCompleted = forShopping && currentShoppingList && currentShoppingList.items && currentShoppingList.items[itemId] && currentShoppingList.items[itemId].completed;
                    
                    let itemClass = 'item';
                    if (forShopping && isCompleted) {
                        itemClass += ' completed';
                    } else if (isSelected) {
                        itemClass += ' selected';
                    }
                    
                    categoryHTML += `
                        <div class="${itemClass}" onclick="${forShopping ? 'toggleShoppingItem' : 'toggleItem'}('${itemId}')">
                            ${forShopping ? `<input type="checkbox" class="item-checkbox" ${isCompleted ? 'checked' : ''} onclick="event.stopPropagation()">` : ''}
                            <span class="item-name">${item}</span>
                            <span class="item-status">${isCompleted ? '‚úÖ' : (isSelected ? '‚úì' : '')}</span>
                            ${forEditing ? `<button class="item-remove" onclick="event.stopPropagation(); removeItem('${itemId}')">‚úï</button>` : ''}
                        </div>
                    `;
                });
                
                // Agregar input para items personalizados
                if (!forShopping) {
                    categoryHTML += `
                        <div class="add-custom-item">
                            <input type="text" placeholder="Agregar item personalizado..." onkeypress="handleCustomItemKeypress(event, '${categoryKey}')">
                            <button onclick="addCustomItem('${categoryKey}')">+</button>
                        </div>
                    `;
                }
                
                // Mostrar items personalizados
                if (customItems[categoryKey]) {
                    customItems[categoryKey].forEach(item => {
                        const itemId = `${categoryKey}-custom-${item.replace(/\s+/g, '-').toLowerCase()}`;
                        const isSelected = currentListData[itemId] || false;
                        const isCompleted = forShopping && currentShoppingList && currentShoppingList.items && currentShoppingList.items[itemId] && currentShoppingList.items[itemId].completed;
                        
                        let itemClass = 'item';
                        if (forShopping && isCompleted) {
                            itemClass += ' completed';
                        } else if (isSelected) {
                            itemClass += ' selected';
                        }
                        
                        categoryHTML += `
                            <div class="${itemClass}" onclick="${forShopping ? 'toggleShoppingItem' : 'toggleItem'}('${itemId}')">
                                ${forShopping ? `<input type="checkbox" class="item-checkbox" ${isCompleted ? 'checked' : ''} onclick="event.stopPropagation()">` : ''}
                                <span class="item-name">${item}</span>
                                <span class="item-status">${isCompleted ? '‚úÖ' : (isSelected ? '‚úì' : '')}</span>
                                ${forEditing ? `<button class="item-remove" onclick="event.stopPropagation(); removeCustomItem('${categoryKey}', '${item}')">‚úï</button>` : ''}
                            </div>
                        `;
                    });
                }
                
                categoryDiv.innerHTML = categoryHTML;
                container.appendChild(categoryDiv);
            });
        }

        function toggleItem(itemId) {
            currentListData[itemId] = !currentListData[itemId];
            generateCategories('categories-container');
        }

        function toggleShoppingItem(itemId) {
            if (!currentShoppingList.items) {
                currentShoppingList.items = {};
            }
            
            if (!currentShoppingList.items[itemId]) {
                currentShoppingList.items[itemId] = { completed: false };
            }
            
            currentShoppingList.items[itemId].completed = !currentShoppingList.items[itemId].completed;
            
            // Actualizar en Supabase
            updateShoppingListInSupabase();
            
            // Actualizar UI
            generateCategories('shopping-categories-container', true);
            updateShoppingProgress();
        }

        function handleCustomItemKeypress(event, categoryKey) {
            if (event.key === 'Enter') {
                addCustomItem(categoryKey);
            }
        }

        function addCustomItem(categoryKey) {
            const input = document.querySelector(`#${editMode ? 'edit-' : ''}categories-container .category.${categoryKey} .add-custom-item input`);
            const itemName = input.value.trim();
            
            if (itemName) {
                if (!customItems[categoryKey]) {
                    customItems[categoryKey] = [];
                }
                
                if (!customItems[categoryKey].includes(itemName)) {
                    customItems[categoryKey].push(itemName);
                    input.value = '';
                    
                    if (editMode) {
                        generateCategories('edit-categories-container', false, true);
                    } else {
                        generateCategories('categories-container');
                    }
                }
            }
        }

        function removeItem(itemId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este item?')) {
                delete currentListData[itemId];
                generateCategories('edit-categories-container', false, true);
            }
        }

        function removeCustomItem(categoryKey, itemName) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este item personalizado?')) {
                const index = customItems[categoryKey].indexOf(itemName);
                if (index > -1) {
                    customItems[categoryKey].splice(index, 1);
                    
                    // Tambi√©n eliminar del currentListData
                    const itemId = `${categoryKey}-custom-${itemName.replace(/\s+/g, '-').toLowerCase()}`;
                    delete currentListData[itemId];
                    
                    generateCategories('edit-categories-container', false, true);
                }
            }
        }

        async function saveList() {
            const listName = document.getElementById('list-name').value.trim();
            const familyMember = document.getElementById('family-member').value;
            const listDate = document.getElementById('list-date').value;
            
            if (!listName) {
                alert('Por favor, ingresa un nombre para la lista');
                return;
            }
            
            // Contar items seleccionados
            const selectedItems = Object.keys(currentListData).filter(key => currentListData[key]);
            const totalCustomItems = Object.values(customItems).reduce((sum, items) => sum + items.length, 0);
            
            if (selectedItems.length === 0 && totalCustomItems === 0) {
                alert('Por favor, selecciona al menos un item para la lista');
                return;
            }
            
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<div class="loading"></div> Guardando...';
            saveBtn.disabled = true;
            
            const listData = {
                name: listName,
                created_by: familyMember,
                date: listDate || new Date().toISOString().split('T')[0],
                items: currentListData,
                custom_items: customItems,
                created_at: new Date().toISOString(),
                total_items: selectedItems.length + totalCustomItems,
                completed_items: 0
            };
            
            try {
                const saved = await saveToSupabase(listData);
                
                if (saved || !isConnected) {
                    // Si no hay conexi√≥n, guardar localmente
                    if (!saved) {
                        const localLists = JSON.parse(localStorage.getItem('shopping_lists') || '[]');
                        listData.id = Date.now(); // ID temporal
                        localLists.unshift(listData);
                        localStorage.setItem('shopping_lists', JSON.stringify(localLists));
                    }
                    
                    alert('Lista guardada exitosamente!');
                    
                    // Limpiar formulario
                    document.getElementById('list-name').value = '';
                    document.getElementById('list-date').value = '';
                    currentListData = {};
                    customItems = {};
                    generateCategories('categories-container');
                    
                    // Mostrar listas guardadas
                    showSection('saved-lists');
                } else {
                    alert('Error al guardar la lista');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la lista');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        async function loadSavedLists() {
            const container = document.getElementById('saved-lists-container');
            container.innerHTML = '<div class="loading" style="margin: 20px auto;"></div>';
            
            try {
                let lists = [];
                
                if (isConnected) {
                    lists = await loadFromSupabase();
                } else {
                    // Cargar de localStorage si no hay conexi√≥n
                    lists = JSON.parse(localStorage.getItem('shopping_lists') || '[]');
                }
                
                savedLists = lists;
                
                if (lists.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No hay listas guardadas</h3>
                            <p>Crea tu primera lista de compras usando el bot√≥n "Nueva Lista"</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                lists.forEach((list, index) => {
                    const listDiv = document.createElement('div');
                    listDiv.className = 'saved-list';
                    
                    const createdDate = new Date(list.created_at).toLocaleDateString();
                    const progress = list.total_items > 0 ? Math.round((list.completed_items / list.total_items) * 100) : 0;
                    
                    listDiv.innerHTML = `
                        <h3>${list.name}</h3>
                        <div class="saved-list-meta">
                            Creada por ${list.created_by} - ${createdDate}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="saved-list-meta">
                            Progreso: ${list.completed_items}/${list.total_items} items (${progress}%)
                        </div>
                        <div class="saved-list-items">
                            ${generateSavedListItems(list)}
                        </div>
                        <div class="list-actions">
                            <button class="shop-list-btn touchable" onclick="startShopping(${index})">
                                üõí Comprar
                            </button>
                            <button class="edit-list-btn touchable" onclick="editList(${index})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="delete-list-btn touchable" onclick="deleteList(${index})">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(listDiv);
                });
                
            } catch (error) {
                console.error('Error cargando listas:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Error cargando listas</h3>
                        <p>Intenta recargar la p√°gina</p>
                    </div>
                `;
            }
        }

        function generateSavedListItems(list) {
            let itemsHTML = '';
            let itemCount = 0;
            const maxItems = 6; // Mostrar m√°ximo 6 items
            
            // Items base
            Object.keys(list.items || {}).forEach(itemId => {
                if (list.items[itemId] && itemCount < maxItems) {
                    const isCompleted = list.items && list.items[itemId] && list.items[itemId].completed;
                    const itemName = getItemNameFromId(itemId);
                    itemsHTML += `<div class="saved-item ${isCompleted ? 'completed' : ''}">${itemName}</div>`;
                    itemCount++;
                }
            });
            
            // Items personalizados
            if (list.custom_items) {
                Object.keys(list.custom_items).forEach(categoryKey => {
                    list.custom_items[categoryKey].forEach(item => {
                        if (itemCount < maxItems) {
                            const itemId = `${categoryKey}-custom-${item.replace(/\s+/g, '-').toLowerCase()}`;
                            const isCompleted = list.items && list.items[itemId] && list.items[itemId].completed;
                            itemsHTML += `<div class="saved-item ${isCompleted ? 'completed' : ''}">${item}</div>`;
                            itemCount++;
                        }
                    });
                });
            }
            
            if (itemCount === 0) {
                itemsHTML = '<div class="saved-item">Lista vac√≠a</div>';
            } else if (list.total_items > maxItems) {
                itemsHTML += `<div class="saved-item">... y ${list.total_items - maxItems} m√°s</div>`;
            }
            
            return itemsHTML;
        }

        function getItemNameFromId(itemId) {
            const parts = itemId.split('-');
            const categoryKey = parts[0];
            
            if (parts.includes('custom')) {
                return parts.slice(2).join(' ').replace(/\b\w/g, l => l.toUpperCase());
            }
            
            const category = baseProducts[categoryKey];
            if (category) {
                const itemName = parts.slice(1).join(' ').replace(/\b\w/g, l => l.toUpperCase());
                const foundItem = category.items.find(item => 
                    item.toLowerCase().replace(/\s+/g, '-') === parts.slice(1).join('-')
                );
                return foundItem || itemName;
            }
            
            return itemId;
        }

        function startShopping(listIndex) {
            const list = savedLists[listIndex];
            currentShoppingList = { ...list };
            
            // Inicializar items si no existen
            if (!currentShoppingList.items) {
                currentShoppingList.items = {};
                
                // Marcar items seleccionados
                Object.keys(list.items || {}).forEach(itemId => {
                    if (list.items[itemId]) {
                        currentShoppingList.items[itemId] = { completed: false };
                    }
                });
                
                // Agregar items personalizados
                if (list.custom_items) {
                    Object.keys(list.custom_items).forEach(categoryKey => {
                        list.custom_items[categoryKey].forEach(item => {
                            const itemId = `${categoryKey}-custom-${item.replace(/\s+/g, '-').toLowerCase()}`;
                            currentShoppingList.items[itemId] = { completed: false };
                        });
                    });
                }
            }
            
            // Configurar para modo compra
            currentListData = {};
            customItems = list.custom_items || {};
            
            Object.keys(currentShoppingList.items).forEach(itemId => {
                currentListData[itemId] = true;
            });
            
            shoppingMode = true;
            document.getElementById('shopping-list-name').textContent = `üõí ${list.name}`;
            
            // Ocultar botones de navegaci√≥n
            document.querySelector('.nav-buttons').style.display = 'none';
            
            // Mostrar secci√≥n de compra
            showSection('shopping-mode');
            generateCategories('shopping-categories-container', true);
            updateShoppingProgress();
        }

        function updateShoppingProgress() {
            if (!currentShoppingList || !currentShoppingList.items) return;
            
            const items = Object.values(currentShoppingList.items);
            const completed = items.filter(item => item.completed).length;
            const total = items.length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('remaining-count').textContent = total - completed;
            document.getElementById('progress-percent').textContent = `${progress}%`;
            document.getElementById('shopping-progress').style.width = `${progress}%`;
        }

        async function updateShoppingListInSupabase() {
            if (!isConnected || !currentShoppingList.id) return;
            
            const items = Object.values(currentShoppingList.items || {});
            const completedItems = items.filter(item => item.completed).length;
            
            const updateData = {
                items: currentShoppingList.items,
                completed_items: completedItems
            };
            
            await updateInSupabase(currentShoppingList.id, updateData);
        }

        function finishShopping() {
            if (confirm('¬øHas terminado de comprar? Esto marcar√° la lista como completada.')) {
                // Marcar todos los items como completados
                if (currentShoppingList.items) {
                    Object.keys(currentShoppingList.items).forEach(itemId => {
                        currentShoppingList.items[itemId].completed = true;
                    });
                }
                
                updateShoppingListInSupabase();
                exitShoppingMode();
                alert('¬°Compra completada exitosamente!');
            }
        }

        function exitShoppingMode() {
            shoppingMode = false;
            currentShoppingList = null;
            document.querySelector('.nav-buttons').style.display = 'flex';
            showSection('saved-lists');
        }

        function editList(listIndex) {
            const list = savedLists[listIndex];
            currentEditingList = { ...list };
            
            // Configurar datos para edici√≥n
            currentListData = { ...list.items };
            customItems = { ...list.custom_items } || {};
            
            // Llenar formulario de edici√≥n
            document.getElementById('edit-list-name-input').value = list.name;
            document.getElementById('edit-family-member').value = list.created_by;
            document.getElementById('edit-list-name').textContent = `‚úèÔ∏è Editar: ${list.name}`;
            
            editMode = true;
            
            // Ocultar botones de navegaci√≥n
            document.querySelector('.nav-buttons').style.display = 'none';
            
            // Mostrar secci√≥n de edici√≥n
            showSection('edit-mode');
            generateCategories('edit-categories-container', false, true);
        }

        async function saveEditedList() {
            const listName = document.getElementById('edit-list-name-input').value.trim();
            const familyMember = document.getElementById('edit-family-member').value;
            
            if (!listName) {
                alert('Por favor, ingresa un nombre para la lista');
                return;
            }
            
            const selectedItems = Object.keys(currentListData).filter(key => currentListData[key]);
            const totalCustomItems = Object.values(customItems).reduce((sum, items) => sum + items.length, 0);
            
            if (selectedItems.length === 0 && totalCustomItems === 0) {
                alert('Por favor, selecciona al menos un item para la lista');
                return;
            }
            
            const updateData = {
                name: listName,
                created_by: familyMember,
                items: currentListData,
                custom_items: customItems,
                total_items: selectedItems.length + totalCustomItems
            };
            
            try {
                if (isConnected && currentEditingList.id) {
                    await updateInSupabase(currentEditingList.id, updateData);
                } else {
                    // Actualizar en localStorage
                    const localLists = JSON.parse(localStorage.getItem('shopping_lists') || '[]');
                    const index = localLists.findIndex(l => l.id === currentEditingList.id);
                    if (index > -1) {
                        localLists[index] = { ...localLists[index], ...updateData };
                        localStorage.setItem('shopping_lists', JSON.stringify(localLists));
                    }
                }
                
                alert('Lista actualizada exitosamente!');
                exitEditMode();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la lista');
            }
        }

        function exitEditMode() {
            editMode = false;
            currentEditingList = null;
            currentListData = {};
            customItems = {};
            document.querySelector('.nav-buttons').style.display = 'flex';
            showSection('saved-lists');
        }

        async function deleteList(listIndex) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta lista?')) {
                const list = savedLists[listIndex];
                
                try {
                    if (isConnected && list.id) {
                        await deleteFromSupabase(list.id);
                    } else {
                        // Eliminar de localStorage
                        const localLists = JSON.parse(localStorage.getItem('shopping_lists') || '[]');
                        const filteredLists = localLists.filter(l => l.id !== list.id);
                        localStorage.setItem('shopping_lists', JSON.stringify(filteredLists));
                    }
                    
                    alert('Lista eliminada exitosamente');
                    loadSavedLists();
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al eliminar la lista');
                }
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar fecha por defecto
            const today = new Date();
            document.getElementById('list-date').value = today.toISOString().split('T')[0];
            
            // Generar categor√≠as iniciales
            generateCategories('categories-container');
            
            // Inicializar Supabase
            initSupabase();
            
            // Cargar listas guardadas si estamos en esa secci√≥n
            if (document.getElementById('saved-lists').classList.contains('active')) {
                loadSavedLists();
            }
        });

        // Prevenir zoom en dispositivos m√≥viles
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>    
