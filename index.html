<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lista de Supermercado Familiar</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
            font-size: 16px;
            line-height: 1.5;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 16px);
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 24px 20px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: #ef4444;
            animation: none;
        }

        .main-content {
            padding: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding: 4px;
            background: #f8fafc;
            border-radius: 16px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-buttons::-webkit-scrollbar {
            display: none;
        }

        .btn {
            background: transparent;
            color: #64748b;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            min-width: fit-content;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .btn.shopping-mode {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
        }

        .btn.edit-mode {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #ffffff;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .categories {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 32px;
        }

        .category {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }

        .category:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .category.dairy { 
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            border-color: #fbbf24;
        }
        .category.meat { 
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #f87171;
        }
        .category.vegetables { 
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #4ade80;
        }
        .category.fruits { 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #60a5fa;
        }
        .category.grains { 
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fbbf24;
        }
        .category.beverages { 
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border-color: #a78bfa;
        }
        .category.cleaning { 
            background: linear-gradient(135deg, #fafafa 0%, #f4f4f5 100%);
            border-color: #a1a1aa;
        }
        .category.condimentos { 
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-color: #fb923c;
        }
        .category.abarrotes { 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-color: #64748b;
        }
        .category.Javier { 
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            border-color: #f472b6;
        }
        .category.Copito { 
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: #38bdf8;
        }

        .category h3 {
            color: #1f2937;
            margin-bottom: 16px;
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            touch-action: manipulation;
            min-height: 56px;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .item:hover {
            background: rgba(255,255,255,0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .item:active {
            transform: scale(0.98);
        }

        .item.selected {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }

        .item.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }

        .item.completed .item-name {
            text-decoration: line-through;
            opacity: 0.8;
        }

        .item-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: #6366f1;
        }

        .item-name {
            flex-grow: 1;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .item-quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: inherit;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .quantity-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .quantity-btn:active {
            transform: scale(0.95);
        }

        .item:not(.selected):not(.completed) .quantity-btn {
            background: #f3f4f6;
            color: #374151;
        }

        .quantity-display {
            min-width: 36px;
            text-align: center;
            font-weight: 600;
            font-size: 0.95rem;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .item:not(.selected):not(.completed) .quantity-display {
            background: #f9fafb;
            color: #374151;
        }

        .item-status {
            font-size: 1.25rem;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .item-remove {
            background: #ef4444;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            display: none;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 8px;
            transition: all 0.2s ease;
        }

        .edit-mode .item-remove {
            display: flex;
        }

        .item-remove:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .item-remove:active {
            transform: scale(0.95);
        }

        .add-custom-item {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .add-custom-item input {
            flex-grow: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .add-custom-item input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .add-custom-item button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.125rem;
            min-width: 48px;
            touch-action: manipulation;
            transition: all 0.3s ease;
        }

        .add-custom-item button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .add-custom-item button:active {
            transform: scale(0.95);
        }

        .saved-lists {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .saved-list {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }

        .saved-list:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .saved-list:active {
            transform: scale(0.98);
        }

        .saved-list h3 {
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .saved-list-meta {
            color: #6b7280;
            font-size: 0.8rem;
            margin-bottom: 16px;
            font-weight: 400;
        }

        .saved-list-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .saved-item {
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .saved-item:hover {
            background: #f1f5f9;
        }

        .saved-item.completed {
            background: #d1fae5;
            text-decoration: line-through;
            opacity: 0.8;
        }

        .saved-item-quantity {
            background: #e2e8f0;
            color: #475569;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .saved-item.completed .saved-item-quantity {
            background: #a7f3d0;
            color: #065f46;
        }

        .list-actions {
            display: flex;
            gap: 8px;
        }

        .delete-list-btn, .shop-list-btn, .edit-list-btn {
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            touch-action: manipulation;
            flex: 1;
            transition: all 0.3s ease;
        }

        .delete-list-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .shop-list-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
        }

        .edit-list-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .delete-list-btn:hover, .shop-list-btn:hover, .edit-list-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .delete-list-btn:active, .shop-list-btn:active, .edit-list-btn:active {
            transform: scale(0.95);
        }

        .progress-bar {
            background: #e5e7eb;
            border-radius: 12px;
            height: 6px;
            margin: 12px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            height: 100%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .shopping-header, .edit-header {
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .shopping-header::before, .edit-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
            opacity: 0.3;
        }

        .shopping-header {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
        }

        .edit-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .shopping-header h2, .edit-header h2 {
            font-size: 1.375rem;
            font-weight: 600;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .shopping-progress {
            margin: 16px 0;
            position: relative;
            z-index: 1;
        }

        .shopping-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 16px;
            position: relative;
            z-index: 1;
        }

        .stat {
            text-align: center;
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: #374151;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        .save-button-container {
            text-align: center;
            margin: 32px 0;
        }

        .save-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 1.125rem;
            font-weight: 600;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
            width: 100%;
            touch-action: manipulation;
            transition: all 0.3s ease;
        }

        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
        }

        .save-button:active {
            transform: scale(0.98);
        }

        .save-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .finish-shopping-container, .finish-editing-container {
            text-align: center;
            margin-top: 32px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .finish-shopping-btn, .finish-editing-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 1.125rem;
            font-weight: 600;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
            touch-action: manipulation;
            transition: all 0.3s ease;
        }

        .exit-shopping-btn, .exit-editing-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            touch-action: manipulation;
            transition: all 0.3s ease;
        }

        .finish-shopping-btn:hover, .finish-editing-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
        }

        .exit-shopping-btn:hover, .exit-editing-btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .finish-shopping-btn:active, .exit-shopping-btn:active,
        .finish-editing-btn:active, .exit-editing-btn:active {
            transform: scale(0.98);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .pulse {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .edit-mode-controls {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .edit-mode-controls h4 {
            color: #92400e;
            margin-bottom: 8px;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .edit-mode-controls p {
            color: #92400e;
            font-size: 0.8rem;
            margin: 0;
        }

        /* Responsive optimizations */
        @media screen and (max-width: 480px) {
            body {
                padding: 4px;
            }

            .container {
                border-radius: 16px;
                min-height: calc(100vh - 8px);
            }

            .header {
                padding: 20px 16px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .main-content {
                padding: 16px;
            }

            .categories {
                gap: 16px;
            }

            .category {
                padding: 16px;
            }

            .item {
                padding: 12px;
                min-height: 52px;
            }

            .item-name {
                font-size: 0.875rem;
            }

            .shopping-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat {
                padding: 10px;
            }

            .stat-number {
                font-size: 1.25rem;
            }

            .saved-list-items {
                grid-template-columns: 1fr;
            }

            .list-actions {
                flex-direction: column;
                gap: 8px;
            }

            .quantity-btn {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }

            .quantity-display {
                min-width: 32px;
                font-size: 0.875rem;
                padding: 4px 8px;
            }

            .form-group input, .form-group select {
                padding: 14px;
            }

            .nav-buttons {
                gap: 8px;
                padding: 2px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.8rem;
            }
        }
        /* Estilos para el sistema de carpetas */
.folder-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}

.folder-btn {
    background: #ffffff;
    color: #64748b;
    border: 1px solid #e5e7eb;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s ease;
    white-space: nowrap;
    touch-action: manipulation;
}

.folder-btn:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
}

.folder-btn.active {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    border-color: #6366f1;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

.folder-btn.new-folder {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-color: #10b981;
}

.folder-btn.new-folder:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
}

/* Estilos para modales */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal {
    background: white;
    border-radius: 16px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
}

.modal-header h3 {
    margin: 0;
    color: #1f2937;
    font-size: 1.125rem;
    font-weight: 600;
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.close-modal:hover {
    background: #f3f4f6;
    color: #374151;
}

.modal-content {
    padding: 20px;
}

.folder-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
}

.folder-option {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.875rem;
    text-align: left;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.folder-option:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
    transform: translateY(-1px);
}

.folder-option:active {
    transform: scale(0.98);
}

.create-folder-section {
    border-top: 1px solid #e5e7eb;
    padding-top: 20px;
    display: flex;
    gap: 8px;
}

.create-folder-section input {
    flex: 1;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
}

.create-folder-section button {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.3s ease;
}

.create-folder-section button:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
}

.modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 20px;
}

.modal-actions button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.modal-actions button:first-child {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
}

.modal-actions button:first-child:hover {
    background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
}

.modal-actions button:last-child {
    background: #f3f4f6;
    color: #374151;
}

.modal-actions button:last-child:hover {
    background: #e5e7eb;
}

/* Actualizar estilos de botones de lista */
.list-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.list-actions button {
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 500;
    touch-action: manipulation;
    transition: all 0.3s ease;
}

.delete-list-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.shop-list-btn {
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
    color: white;
}

.edit-list-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.folder-btn.list-action {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
}

.list-actions button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.list-actions button:active {
    transform: scale(0.95);
}

/* Responsive para carpetas */
@media screen and (max-width: 480px) {
    .folder-selector {
        padding: 12px;
        gap: 6px;
    }
    
    .folder-btn {
        padding: 6px 12px;
        font-size: 0.8rem;
    }
    
    .modal {
        width: 95%;
        margin: 10px;
    }
    
    .modal-content {
        padding: 16px;
    }
    
    .modal-header {
        padding: 16px;
    }
    
    .list-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
    }
    
    .list-actions button {
        padding: 6px 8px;
        font-size: 0.7rem;
    }
    
    .create-folder-section {
        flex-direction: column;
    }
    
    .create-folder-section button {
        width: 100%;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>🛒 Lista de Supermercado</h1>
                <p>Familia con Orejas</p>
                <div class="connection-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="connectionStatus">Conectando a family...</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="nav-buttons">
                <button class="btn active" data-section="create"><span>📝 Crear Lista</span></button>
                <button class="btn" data-section="saved"><span>💾 Listas Guardadas</span></button>
                <button class="btn" data-section="shopping" id="shoppingBtn" style="display: none;"><span>🛍️ Comprar</span></button>
                <button class="btn" data-section="edit" id="editBtn" style="display: none;"><span>✏️ Editar</span></button>
            </div>

            <!-- Sección Crear Lista -->
            <div id="create" class="section active">
                <div class="form-group">
                    <label for="listName">Nombre de la lista:</label>
                    <input type="text" id="listName" placeholder="Ej: Compras del sábado" value="">
                </div>

                <div class="categories" id="categories">
                    <!-- Las categorías se generarán dinámicamente -->
                </div>

                <div class="save-button-container">
                    <button class="save-button" id="saveList">
                        <span id="saveButtonText">💾 Guardar Lista</span>
                        <div class="loading" id="saveButtonLoading" style="display: none;"></div>
                    </button>
                </div>
            </div>

            <!-- Sección Listas Guardadas -->
            <div id="saved" class="section">
                <div class="saved-lists" id="savedLists">
                    <div class="empty-state">
                        <h3>No hay listas guardadas</h3>
                        <p>Crea tu primera lista para comenzar</p>
                    </div>
                </div>
            </div>

            <!-- Sección Comprar -->
            <div id="shopping" class="section">
                <div class="shopping-header">
                    <h2>🛍️ Modo Compra</h2>
                    <div class="shopping-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="shoppingProgress"></div>
                        </div>
                        <div class="shopping-stats">
                            <div class="stat">
                                <span class="stat-number" id="completedCount">0</span>
                                <span class="stat-label">Completados</span>
                            </div>
                            <div class="stat">
                                <span class="stat-number" id="totalCount">0</span>
                                <span class="stat-label">Total</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="categories" id="shoppingCategories">
                    <!-- Las categorías se generarán dinámicamente -->
                </div>

                <div class="finish-shopping-container">
                    <button class="finish-shopping-btn" id="finishShopping">
                        ✅ Finalizar Compra
                    </button>
                    <button class="exit-shopping-btn" id="exitShopping">
                        🔙 Volver a Listas
                    </button>
                </div>
            </div>

            <!-- Sección Editar -->
            <div id="edit" class="section">
                <div class="edit-header">
                    <h2>✏️ Editar Lista</h2>
                    <div class="realtime-indicator">
                        <div class="pulse"></div>
                        <span>Cambios en tiempo real</span>
                    </div>
                </div>

                <div class="edit-mode-controls">
                    <h4>Modo Edición Activado</h4>
                    <p>Puedes agregar, quitar items y cambiar cantidades</p>
                </div>

                <div class="form-group">
                    <label for="editListName">Nombre de la lista:</label>
                    <input type="text" id="editListName" placeholder="Ej: Compras del sábado">
                </div>

                <div class="categories edit-mode" id="editCategories">
                    <!-- Las categorías se generarán dinámicamente -->
                </div>

                <div class="finish-editing-container">
                    <button class="finish-editing-btn" id="finishEditing">
                        💾 Guardar Cambios
                    </button>
                    <button class="exit-editing-btn" id="exitEditing">
                        🔙 Volver a Listas
                    </button>
                     <p>made in jota</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración Supabase
        const supabaseUrl = 'https://fkbibznxasdkzrrqecul.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrYmliem54YXNka3pycnFlY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MTUxNDcsImV4cCI6MjA2Njk5MTE0N30.usnm1yQ3dWdjvUHPW3YZmL3WQQJyp6lD3ot8IqmpSwA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Estado de la aplicación
        let currentUser = null;
        let currentList = null;
        let currentMode = 'create';
        let isConnected = false;

        // Categorías predefinidas con items
        const categories = {
            vegetables: {
                name: 'Verduras',
                icon: '🥬',
                items: ['Tomate', 'Cebolla', 'Ajo', 'Zanahoria', 'Lechuga', 'Pepino', 'Palta','Betarraga','coliflor','Brocoli','Zapallo amarillo','Zapallo italiano','Repollo','Morron','Cebollín','Cilantro','champiñon','Acelga','Ají verde','Limones','Choclo','Apío','Cochayuyo','Papa','Alcachofa','Jengibre','Espinaca']
            },
            fruits: {
                name: 'Frutas',
                icon: '🍎',
                items: ['Manzana', 'Plátano', 'Naranja', 'Limón', 'Frutilla', 'Uva', 'Pera','Sandía','Melón','Kiwi','Pomelo','Mango','Membrillo']
            },
            meat: {
                name: 'Carnes',
                icon: '🥩',
                items: ['Pollo', 'Carne molida','Carne a la olla','Carne a la parrilla', 'Escalopa', 'Bistec', 'Cerdo', 'Pescado', 'Jamón', 'Salchichas','Salame','Pepinillos','Aceitunas']
            },
            dairy: {
                name: 'Lácteos',
                icon: '🥛',
                items: ['Leche', 'Queso', 'Yogurt', 'Mantequilla', 'Crema', 'Queso crema', 'Postres','Leche cultivada','Leche condensada','Leche evaporada','Manjar','Queso rallado','Huevos']
            },
            abarrotes: {
                name: 'Abarrotes',
                icon: '🏪',
                items: ['Aceite', 'Sal', 'Azúcar', 'Harinas con/sin','Aceite de oliva','Aceto balsamico','Vinagre tinto','Vinagre de manzana','Ketchup','Mostaza','Mayonessa','Jalea en polvo','postres en polvo','Mermelada','Polvo de hornear','Maicena','Pan rayado','Pan de molde','Quezadillas,','Palmitos','Jurel','Atún','Durazno','Puré','Salsa de tomate','Cereal','Natur','Galletas','Chocolate margo','Chocolate dulce','Snacks','Sopas','Bases pollo crispy','Base pollo mediterranio','Base de cazuela','Endulzante', 'Ají en pasta','Dulce membrillo']
            },
            
            
            grains: {
                name: 'Cereales',
                icon: '🌾',
                items: ['Arroz', 'Pasta', 'Pan', 'Avena', 'Quinoa', 'Lentejas', 'Mote','Poroto','Garbanzo','Porotos granados','Lasagna']
            },
            condimentos: {
                name: 'Condimentos',
                icon: '🧂',
                items: ['Ajo en polvo', 'Oregano','Romero','Papikra','Ají color','Cebolla en polvo', 'Sesamo','Curcuma','Merkén','Pimienta','Clavo de olor','Laurel','Canela','Calugas maggi','Jengibre en polvo','Nuez Moscada','Vainilla','Salsa soya','Salsa inglesa','Salsa de tabasco','Anís']
            },
            beverages: {
                name: 'Bebidas',
                icon: '🥤',
                items: ['Agua', 'Jugo', 'Bebida', 'Café', 'Té', 'Vino', 'Cerveza','Tragos','Té papa','Aguas dani','Agua Bidon']
            },
            cleaning: {
                name: 'Limpieza',
                icon: '🧽',
                items: ['Detergente', 'Cloro', 'Jabón', 'Papel higiénico', 'Shampoo', 'Pasta dental','Acondicionador','Quiz','Limpia vidrios','Crema de baño','Lustra mueble','Bolsa de basura','Esponja','Suavizante','Jabon en barra', 'Jabon liquido','Virutilla','Anti grasa','Escoba','Poett','Cepillo de diente','desodorante hombre','Desodorante mujer','Maquina de afeitar','Maquina de depilación','Crema de cara','Crema de cuerpo','Toallas higienicas','Nova','Servilletas']
            },
            
            
            Javier: {
                name: 'Javier',
                icon: '👨',
                items: ['Papitas fritas','Postres ricos','Bebidas','Chocolate','Nutella','Viajar a iquique','Mesada de 100mil']
            },
            Copito: {
                name: 'Copito',
                icon: '🐕',
                items: ['Comida','Snacks']
            }
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            renderCategories();
        });

        // Configuración inicial
        async function initializeApp() {
            try {
                // Verificar conexión
                const { data, error } = await supabase.from('shopping_lists').select('count', { count: 'exact' });
                if (error) throw error;
                
                updateConnectionStatus(true);
                loadSavedLists();
            } catch (error) {
                console.error('Error inicializando:', error);
                updateConnectionStatus(false);
            }
        }

        // Actualizar estado de conexión
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                indicator.className = 'status-indicator';
                status.textContent = 'Conectado a family!';
            } else {
                indicator.className = 'status-indicator disconnected';
                status.textContent = 'Sin conexión a family :(';
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Navegación
            document.querySelectorAll('.nav-buttons .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.dataset.section;
                    switchSection(section);
                });
            });

            // Guardar lista
            document.getElementById('saveList').addEventListener('click', saveCurrentList);

            // Botones de compra
            document.getElementById('finishShopping').addEventListener('click', finishShopping);
            document.getElementById('exitShopping').addEventListener('click', () => switchSection('saved'));

            // Botones de edición
            document.getElementById('finishEditing').addEventListener('click', finishEditing);
            document.getElementById('exitEditing').addEventListener('click', () => switchSection('saved'));
        }

        // Cambiar sección
        function switchSection(section) {
            // Actualizar botones
            document.querySelectorAll('.nav-buttons .btn').forEach(btn => {
                btn.classList.remove('active', 'shopping-mode', 'edit-mode');
                if (btn.dataset.section === section) {
                    btn.classList.add('active');
                    if (section === 'shopping') btn.classList.add('shopping-mode');
                    if (section === 'edit') btn.classList.add('edit-mode');
                }
            });

            // Mostrar sección
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(section).classList.add('active');

            currentMode = section;

            // Cargar datos específicos según la sección
            if (section === 'saved') {
                loadSavedLists();
            }
        }

        // Renderizar categorías
        function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = '';

            Object.entries(categories).forEach(([categoryId, category]) => {
                const categoryEl = createCategoryElement(categoryId, category);
                container.appendChild(categoryEl);
            });
        }

        // Crear elemento de categoría
        function createCategoryElement(categoryId, category) {
            const categoryEl = document.createElement('div');
            categoryEl.className = `category ${categoryId}`;
            
            const title = document.createElement('h3');
            title.innerHTML = `${category.icon} ${category.name}`;
            categoryEl.appendChild(title);

            category.items.forEach(item => {
                const itemEl = createItemElement(item, categoryId);
                categoryEl.appendChild(itemEl);
            });

            // Agregar control para items personalizados
            const customItemControl = createCustomItemControl(categoryId);
            categoryEl.appendChild(customItemControl);

            return categoryEl;
        }

        // Crear elemento de item
        function createItemElement(itemName, categoryId, quantity = 1, completed = false) {
            const itemEl = document.createElement('div');
            itemEl.className = `item ${completed ? 'completed' : ''}`;
            itemEl.dataset.item = itemName;
            itemEl.dataset.category = categoryId;

            // Checkbox (solo en modo compra)
            if (currentMode === 'shopping') {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'item-checkbox';
                checkbox.checked = completed;
                checkbox.addEventListener('change', function() {
                    toggleItemCompletion(itemEl, this.checked);
                });
                itemEl.appendChild(checkbox);
            }

            // Nombre del item
            const nameEl = document.createElement('span');
            nameEl.className = 'item-name';
            nameEl.textContent = itemName;
            itemEl.appendChild(nameEl);

            // Controles de cantidad
            const quantityControls = document.createElement('div');
            quantityControls.className = 'item-quantity-controls';

            const decreaseBtn = document.createElement('button');
            decreaseBtn.className = 'quantity-btn';
            decreaseBtn.innerHTML = '−';
            decreaseBtn.addEventListener('click', () => updateQuantity(itemEl, -1));

            const quantityDisplay = document.createElement('span');
            quantityDisplay.className = 'quantity-display';
            quantityDisplay.textContent = quantity;

            const increaseBtn = document.createElement('button');
            increaseBtn.className = 'quantity-btn';
            increaseBtn.innerHTML = '+';
            increaseBtn.addEventListener('click', () => updateQuantity(itemEl, 1));

            quantityControls.appendChild(decreaseBtn);
            quantityControls.appendChild(quantityDisplay);
            quantityControls.appendChild(increaseBtn);

            itemEl.appendChild(quantityControls);

            // Botón de eliminar (solo en modo edición)
            if (currentMode === 'edit') {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'item-remove';
                removeBtn.innerHTML = '×';
                removeBtn.addEventListener('click', () => removeItem(itemEl));
                itemEl.appendChild(removeBtn);
            }

            // Click en el item para seleccionar
            itemEl.addEventListener('click', function(e) {
                if (e.target.classList.contains('quantity-btn') || 
                    e.target.classList.contains('item-checkbox') ||
                    e.target.classList.contains('item-remove')) {
                    return;
                }
                toggleItemSelection(itemEl);
            });

            return itemEl;
        }

        // Crear control para items personalizados
        function createCustomItemControl(categoryId) {
            const container = document.createElement('div');
            container.className = 'add-custom-item';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Agregar item personalizado...';

            const addBtn = document.createElement('button');
            addBtn.innerHTML = '+';
            addBtn.addEventListener('click', () => addCustomItem(categoryId, input));

            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCustomItem(categoryId, input);
                }
            });

            container.appendChild(input);
            container.appendChild(addBtn);

            return container;
        }

        // Agregar item personalizado
        function addCustomItem(categoryId, input) {
            const itemName = input.value.trim();
            if (!itemName) return;

            const category = document.querySelector(`#categories .category.${categoryId}`);
            if (!category) return;

            const itemEl = createItemElement(itemName, categoryId);
            category.insertBefore(itemEl, category.lastElementChild);

            input.value = '';
            toggleItemSelection(itemEl);
        }

        // Alternar selección de item
        function toggleItemSelection(itemEl) {
            if (currentMode === 'shopping') return;
            
            const isSelected = itemEl.classList.contains('selected');
            const quantityDisplay = itemEl.querySelector('.quantity-display');
            
            if (isSelected) {
                itemEl.classList.remove('selected');
                quantityDisplay.textContent = '1';
            } else {
                itemEl.classList.add('selected');
            }
        }

        // Actualizar cantidad
        function updateQuantity(itemEl, change) {
            const quantityDisplay = itemEl.querySelector('.quantity-display');
            let quantity = parseInt(quantityDisplay.textContent) + change;
            
            if (quantity < 1) quantity = 1;
            if (quantity > 99) quantity = 99;
            
            quantityDisplay.textContent = quantity;
            
            if (currentMode === 'create' && quantity > 1) {
                itemEl.classList.add('selected');
            }
        }

        // Eliminar item
        function removeItem(itemEl) {
            itemEl.remove();
        }

        // Alternar completado en modo compra
        function toggleItemCompletion(itemEl, completed) {
            if (completed) {
                itemEl.classList.add('completed');
                itemEl.classList.remove('selected');
            } else {
                itemEl.classList.remove('completed');
            }
            updateShoppingProgress();
        }

        // Actualizar progreso de compra
        function updateShoppingProgress() {
            const items = document.querySelectorAll('#shoppingCategories .item');
            const completedItems = document.querySelectorAll('#shoppingCategories .item.completed');
            
            const total = items.length;
            const completed = completedItems.length;
            const progress = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('shoppingProgress').style.width = progress + '%';
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('totalCount').textContent = total;
        }

        // Guardar lista actual
        async function saveCurrentList() {
            const listName = document.getElementById('listName').value.trim();
            const selectedItems = getSelectedItems();
            
            if (!listName) {
                alert('Por favor ingresa un nombre para la lista');
                return;
            }
            
            if (selectedItems.length === 0) {
                alert('Por favor selecciona al menos un item');
                return;
            }

            const saveBtn = document.getElementById('saveList');
            const saveText = document.getElementById('saveButtonText');
            const saveLoading = document.getElementById('saveButtonLoading');
            
            saveBtn.disabled = true;
            saveText.style.display = 'none';
            saveLoading.style.display = 'inline-block';

            try {
                const { data, error } = await supabase
                    .from('shopping_lists')
                    .insert([{
                        name: listName,
                        items: selectedItems,
                        created_at: new Date().toISOString()
                    }]);

                if (error) throw error;

                alert('Lista guardada exitosamente');
                resetCreateForm();
                loadSavedLists();
                
            } catch (error) {
                console.error('Error guardando lista:', error);
                alert('Error al guardar la lista');
            } finally {
                saveBtn.disabled = false;
                saveText.style.display = 'inline-block';
                saveLoading.style.display = 'none';
            }
        }

        // Obtener items seleccionados
        function getSelectedItems() {
            const selectedItems = [];
            const items = document.querySelectorAll('#categories .item.selected, #categories .item[data-quantity]');
            
            items.forEach(item => {
                const name = item.querySelector('.item-name').textContent;
                const quantity = parseInt(item.querySelector('.quantity-display').textContent);
                const category = item.dataset.category;
                
                if (item.classList.contains('selected') || quantity > 1) {
                    selectedItems.push({
                        name,
                        quantity,
                        category,
                        completed: false
                    });
                }
            });
            
            return selectedItems;
        }

        // Resetear formulario de crear
        function resetCreateForm() {
            document.getElementById('listName').value = '';
            document.querySelectorAll('#categories .item').forEach(item => {
                item.classList.remove('selected');
                item.querySelector('.quantity-display').textContent = '1';
            });
        }

        // Cargar listas guardadas
        async function loadSavedLists() {
            const container = document.getElementById('savedLists');
            
            try {
                const { data, error } = await supabase
                    .from('shopping_lists')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No hay listas guardadas</h3>
                            <p>Crea tu primera lista para comenzar</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                data.forEach(list => {
                    const listEl = createSavedListElement(list);
                    container.appendChild(listEl);
                });
                
            } catch (error) {
                console.error('Error cargando listas:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Error al cargar listas</h3>
                        <p>Revisa tu conexión a internet</p>
                    </div>
                `;
            }
        }

// Crear elemento de lista guardada
function createSavedListElement(list) {
    const listEl = document.createElement('div');
    listEl.className = 'saved-list';
    listEl.dataset.listId = list.id;
    
    const totalItems = list.items.length;
    const completedItems = list.items.filter(item => item.completed).length;
    const progressPercent = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
    
    listEl.innerHTML = `
        <h3>${list.name}</h3>
        <div class="saved-list-meta">
            Creada el ${new Date(list.created_at).toLocaleDateString()} • ${totalItems} items
            ${list.folder_id ? `• Carpeta: ${list.folder_name || 'Sin nombre'}` : ''}
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: ${progressPercent}%"></div>
        </div>
        <div class="saved-list-items">
            ${list.items.map(item => `
                <div class="saved-item ${item.completed ? 'completed' : ''}">
                    <span>${item.name}</span>
                    <span class="saved-item-quantity">${item.quantity}</span>
                </div>
            `).join('')}
        </div>
        <div class="list-actions">
            <button class="shop-list-btn" onclick="startShopping('${list.id}')">🛍️ Comprar</button>
            <button class="edit-list-btn" onclick="editList('${list.id}')">✏️ Editar</button>
            <button class="folder-btn" onclick="showFolderModal('${list.id}')">📁 Carpeta</button>
            <button class="delete-list-btn" onclick="deleteList('${list.id}')">🗑️ Eliminar</button>
        </div>
    `;
    
    return listEl;
}

// Sistema de Carpetas
let folders = [];
let currentFolderId = null;

// Cargar carpetas desde la base de datos
async function loadFolders() {
    try {
        const { data, error } = await supabase
            .from('folders')
            .select('*')
            .order('name');

        if (error) throw error;
        folders = data || [];
        renderFolderSelector();
    } catch (error) {
        console.error('Error cargando carpetas:', error);
    }
}

// Renderizar selector de carpetas
function renderFolderSelector() {
    const container = document.getElementById('folderSelector');
    if (!container) return;

    container.innerHTML = `
        <div class="folder-selector">
            <button class="folder-btn ${currentFolderId === null ? 'active' : ''}" onclick="filterByFolder(null)">
                📋 Todas las listas
            </button>
            ${folders.map(folder => `
                <button class="folder-btn ${currentFolderId === folder.id ? 'active' : ''}" 
                        onclick="filterByFolder('${folder.id}')">
                    📁 ${folder.name}
                </button>
            `).join('')}
            <button class="folder-btn new-folder" onclick="showCreateFolderModal()">
                ➕ Nueva Carpeta
            </button>
        </div>
    `;
}

// Filtrar listas por carpeta
function filterByFolder(folderId) {
    currentFolderId = folderId;
    loadSavedLists();
    renderFolderSelector();
}

// Mostrar modal de carpetas
function showFolderModal(listId) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal">
            <div class="modal-header">
                <h3>Mover a Carpeta</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="folder-options">
                    <button class="folder-option" onclick="moveToFolder('${listId}', null)">
                        📋 Sin carpeta
                    </button>
                    ${folders.map(folder => `
                        <button class="folder-option" onclick="moveToFolder('${listId}', '${folder.id}')">
                            📁 ${folder.name}
                        </button>
                    `).join('')}
                </div>
                <div class="create-folder-section">
                    <input type="text" id="newFolderName" placeholder="Nombre de nueva carpeta...">
                    <button onclick="createAndMoveToFolder('${listId}')">Crear y Mover</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Mostrar modal para crear carpeta
function showCreateFolderModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal">
            <div class="modal-header">
                <h3>Nueva Carpeta</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-content">
                <input type="text" id="folderNameInput" placeholder="Nombre de la carpeta...">
                <div class="modal-actions">
                    <button onclick="createFolder()">Crear Carpeta</button>
                    <button onclick="closeModal()">Cancelar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.getElementById('folderNameInput').focus();
}

// Crear carpeta
async function createFolder() {
    const name = document.getElementById('folderNameInput').value.trim();
    if (!name) return;

    try {
        const { data, error } = await supabase
            .from('folders')
            .insert([{ name }]);

        if (error) throw error;

        closeModal();
        loadFolders();
        alert('Carpeta creada exitosamente');
    } catch (error) {
        console.error('Error creando carpeta:', error);
        alert('Error al crear la carpeta');
    }
}

// Mover lista a carpeta
async function moveToFolder(listId, folderId) {
    try {
        const { error } = await supabase
            .from('shopping_lists')
            .update({ folder_id: folderId })
            .eq('id', listId);

        if (error) throw error;

        closeModal();
        loadSavedLists();
        alert('Lista movida exitosamente');
    } catch (error) {
        console.error('Error moviendo lista:', error);
        alert('Error al mover la lista');
    }
}

// Crear carpeta y mover lista
async function createAndMoveToFolder(listId) {
    const name = document.getElementById('newFolderName').value.trim();
    if (!name) return;

    try {
        const { data, error } = await supabase
            .from('folders')
            .insert([{ name }])
            .select();

        if (error) throw error;

        const folderId = data[0].id;
        await moveToFolder(listId, folderId);
        loadFolders();
    } catch (error) {
        console.error('Error creando carpeta:', error);
        alert('Error al crear la carpeta');
    }
}

// Cerrar modal
function closeModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// Iniciar compra
async function startShopping(listId) {
    try {
        const { data, error } = await supabase
            .from('shopping_lists')
            .select('*')
            .eq('id', listId)
            .single();

        if (error) throw error;

        currentList = data;
        renderShoppingMode();
        switchSection('shopping');
        
        // Mostrar botón de compra en navegación
        document.getElementById('shoppingBtn').style.display = 'block';
        
    } catch (error) {
        console.error('Error iniciando compra:', error);
        alert('Error al cargar la lista');
    }
}

// Renderizar modo compra
function renderShoppingMode() {
    const container = document.getElementById('shoppingCategories');
    container.innerHTML = '';

    // Agrupar items por categoría
    const itemsByCategory = {};
    currentList.items.forEach(item => {
        if (!itemsByCategory[item.category]) {
            itemsByCategory[item.category] = [];
        }
        itemsByCategory[item.category].push(item);
    });

    // Crear categorías
    Object.entries(itemsByCategory).forEach(([categoryId, items]) => {
        const category = categories[categoryId];
        if (!category) return;

        const categoryEl = document.createElement('div');
        categoryEl.className = `category ${categoryId}`;
        
        const title = document.createElement('h3');
        title.innerHTML = `${category.icon} ${category.name}`;
        categoryEl.appendChild(title);

        items.forEach(item => {
            const itemEl = createItemElement(item.name, categoryId, item.quantity, item.completed);
            categoryEl.appendChild(itemEl);
        });

        container.appendChild(categoryEl);
    });

    updateShoppingProgress();
}

// Editar lista
async function editList(listId) {
    try {
        const { data, error } = await supabase
            .from('shopping_lists')
            .select('*')
            .eq('id', listId)
            .single();

        if (error) throw error;

        currentList = data;
        renderEditMode();
        switchSection('edit');
        
        // Mostrar botón de edición en navegación
        document.getElementById('editBtn').style.display = 'block';
        
    } catch (error) {
        console.error('Error cargando lista para editar:', error);
        alert('Error al cargar la lista');
    }
}

// Renderizar modo edición
function renderEditMode() {
    document.getElementById('editListName').value = currentList.name;
    
    const container = document.getElementById('editCategories');
    container.innerHTML = '';

    // Renderizar todas las categorías
    Object.entries(categories).forEach(([categoryId, category]) => {
        const categoryEl = document.createElement('div');
        categoryEl.className = `category ${categoryId}`;
        
        const title = document.createElement('h3');
        title.innerHTML = `${category.icon} ${category.name}`;
        categoryEl.appendChild(title);

        // Agregar items existentes de la lista
        const existingItems = currentList.items.filter(item => item.category === categoryId);
        existingItems.forEach(item => {
            const itemEl = createItemElement(item.name, categoryId, item.quantity, item.completed);
            itemEl.classList.add('selected');
            categoryEl.appendChild(itemEl);
        });

        // Agregar items predefinidos no seleccionados
        category.items.forEach(itemName => {
            const exists = existingItems.some(item => item.name === itemName);
            if (!exists) {
                const itemEl = createItemElement(itemName, categoryId);
                categoryEl.appendChild(itemEl);
            }
        });

        // Agregar control para items personalizados
        const customItemControl = createCustomItemControl(categoryId);
        categoryEl.appendChild(customItemControl);

        container.appendChild(categoryEl);
    });
}

// Finalizar compra
async function finishShopping() {
    if (!currentList) return;

    try {
        // Actualizar estado de los items
        const items = [];
        document.querySelectorAll('#shoppingCategories .item').forEach(itemEl => {
            const name = itemEl.querySelector('.item-name').textContent;
            const quantity = parseInt(itemEl.querySelector('.quantity-display').textContent);
            const category = itemEl.dataset.category;
            const completed = itemEl.classList.contains('completed');
            
            items.push({ name, quantity, category, completed });
        });

        const { error } = await supabase
            .from('shopping_lists')
            .update({ 
                items: items,
                last_shopped: new Date().toISOString()
            })
            .eq('id', currentList.id);

        if (error) throw error;

        alert('Compra finalizada y guardada');
        currentList = null;
        document.getElementById('shoppingBtn').style.display = 'none';
        switchSection('saved');
        
    } catch (error) {
        console.error('Error finalizando compra:', error);
        alert('Error al guardar el progreso');
    }
}

// Finalizar edición
async function finishEditing() {
    if (!currentList) return;

    const newName = document.getElementById('editListName').value.trim();
    if (!newName) {
        alert('Por favor ingresa un nombre para la lista');
        return;
    }

    try {
        const selectedItems = [];
        document.querySelectorAll('#editCategories .item.selected').forEach(itemEl => {
            const name = itemEl.querySelector('.item-name').textContent;
            const quantity = parseInt(itemEl.querySelector('.quantity-display').textContent);
            const category = itemEl.dataset.category;
            
            selectedItems.push({ name, quantity, category, completed: false });
        });

        const { error } = await supabase
            .from('shopping_lists')
            .update({ 
                name: newName,
                items: selectedItems,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentList.id);

        if (error) throw error;

        alert('Lista actualizada exitosamente');
        currentList = null;
        document.getElementById('editBtn').style.display = 'none';
        switchSection('saved');
        loadSavedLists();
        
    } catch (error) {
        console.error('Error actualizando lista:', error);
        alert('Error al actualizar la lista');
    }
}

// Eliminar lista
async function deleteList(listId) {
    if (!confirm('¿Estás seguro de que quieres eliminar esta lista?')) {
        return;
    }

    try {
        const { error } = await supabase
            .from('shopping_lists')
            .delete()
            .eq('id', listId);

        if (error) throw error;

        alert('Lista eliminada exitosamente');
        loadSavedLists();
        
    } catch (error) {
        console.error('Error eliminando lista:', error);
        alert('Error al eliminar la lista');
    }
}

// Modificar la función loadSavedLists para incluir carpetas
async function loadSavedLists() {
    const container = document.getElementById('savedLists');
    
    try {
        let query = supabase
            .from('shopping_lists')
            .select(`
                *,
                folders(name)
            `)
            .order('created_at', { ascending: false });

        // Filtrar por carpeta si hay una seleccionada
        if (currentFolderId) {
            query = query.eq('folder_id', currentFolderId);
        } else if (currentFolderId === null) {
            // Mostrar todas las listas si no hay filtro
        }

        const { data, error } = await query;

        if (error) throw error;

        // Agregar selector de carpetas
        const folderSelector = document.createElement('div');
        folderSelector.id = 'folderSelector';
        container.innerHTML = '';
        container.appendChild(folderSelector);
        
        await loadFolders();

        if (data.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.innerHTML = `
                <h3>No hay listas ${currentFolderId ? 'en esta carpeta' : 'guardadas'}</h3>
                <p>${currentFolderId ? 'Mueve algunas listas a esta carpeta' : 'Crea tu primera lista para comenzar'}</p>
            `;
            container.appendChild(emptyState);
            return;
        }

        data.forEach(list => {
            // Agregar nombre de carpeta si existe
            list.folder_name = list.folders ? list.folders.name : null;
            const listEl = createSavedListElement(list);
            container.appendChild(listEl);
        });
        
    } catch (error) {
        console.error('Error cargando listas:', error);
        container.innerHTML = `
            <div class="empty-state">
                <h3>Error al cargar listas</h3>
                <p>Revisa tu conexión a internet</p>
            </div>
        `;
    }
}

// Inicializar carpetas al cargar la aplicación
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    setupEventListeners();
    renderCategories();
    loadFolders();
});
    </script>
</body>
</html>
